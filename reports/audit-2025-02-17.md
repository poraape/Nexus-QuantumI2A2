# Nexus Quantum I2A2 – Auditoria Técnica End-to-End (17/02/2025)

## 1. Visão Executiva
- **Severidade crítica**: O repositório encontra-se com conflitos de merge não resolvidos em arquivos fundamentais do backend e da orquestração multiagente, impossibilitando qualquer build consistente ou execução homogênea do pipeline.【F:backend/app/main.py†L1-L273】【F:hooks/useAgentOrchestrator.ts†L1-L200】【F:services/chatService.ts†L1-L68】
- **Superfície de ataque ampliada**: APIs backend expõem CORS irrestrito e bootstrap automático de usuário padrão, enquanto o frontend persiste tokens de sessão em `localStorage` sem controles adicionais.【F:backend/app/main.py†L91-L236】【F:backend/app/config.py†L10-L57】【F:services/authService.ts†L3-L66】
- **Arquitetura duplicada**: Coexistem duas pilhas de orquestração (FastAPI/Celery vs. proxy Node + execução client-side), gerando contratos divergentes, telemetria inconsistente e ausência de rastreabilidade ponta a ponta.【F:backend/app/orchestrator.py†L1-L37】【F:backend/app/orchestrator/state_machine.py†L1-L60】【F:services/geminiService.ts†L1-L200】【F:server/index.ts†L1-L200】
- **UX e acessibilidade comprometidas**: A aplicação SPA depende de bibliotecas críticas servidas via CDN externo e componentes-chave não são acessíveis via teclado, além de carecer de fallback responsivo em fluxos de erro.【F:index.html†L1-L41】【F:components/FileUpload.tsx†L384-L456】【F:App.tsx†L21-L168】
- **Esteira quebrada**: Linters e TypeScript não compilam devido a conflitos e configuração incorreta de `tsconfigRootDir`, impedindo qualquer coleta de métricas automatizadas ou execução de testes confiáveis.【6731fa†L1-L88】【4e7cf5†L1-L128】

## 2. Arquitetura, Integridade Lógica e Multiagentes
| Área | Achado | Impacto | Evidências |
| --- | --- | --- | --- |
| Backend | `backend/app/main.py` mantém duas versões completas (REST + GraphQL) separadas por marcadores `<<<<<<<`/`>>>>>>>`, duplicando configurações e rotas, inclusive instâncias distintas de `FastAPI`. | **Crítico** – nenhum servidor pode subir sem resolver conflitos. | 【F:backend/app/main.py†L1-L273】 |
| Orquestração | `PipelineOrchestrator` aparece em duas implementações: uma dependente de Celery e outra como state machine síncrona, sem integração clara com o frontend. | **Alto** – pipeline perde consistência e telemetria. | 【F:backend/app/orchestrator.py†L1-L37】【F:backend/app/orchestrator/state_machine.py†L1-L60】 |
| Frontend Hook | `useAgentOrchestrator` mantém caminhos mutuamente exclusivos (execução local vs. streaming backend) com referências a tipos diferentes (`ChatSession` vs. `Chat`). | **Crítico** – execução client-side quebra ao escolher qualquer ramo. | 【F:hooks/useAgentOrchestrator.ts†L1-L200】 |
| Serviços LLM | `services/chatService.ts` e `services/geminiService.ts` apontam para implementações diferentes (REST backend vs. proxy Express) e expõem esquemas divergentes e chamadas com modelos distintos. | **Alto** – contratos inconsistentes e risco de dupla cobrança em providers externos. | 【F:services/chatService.ts†L1-L68】【F:services/geminiService.ts†L1-L200】 |
| Proxy Node | `server/index.ts` recria integrações ERP, fila própria e proxy Gemini, sem qualquer coordenação com as rotas FastAPI. | **Alto** – aumenta superfície operacional, dificulta observabilidade unificada. | 【F:server/index.ts†L1-L200】 |

## 3. Backend, Segurança e Compliance
- **CORS permissivo**: o backend aceita `allow_origins=['*']`, `allow_methods=['*']` e `allow_headers=['*']`, expondo sessões PKCE a qualquer origem não confiável.【F:backend/app/main.py†L126-L133】
- **Bootstrap de credenciais**: usuários padrão são criados automaticamente quando `DEFAULT_ADMIN_*` é definido, sem exigir rotação posterior ou MFA, e chaves de API podem ser semeadas via `GEMINI_API_KEY` para o cofre local.【F:backend/app/main.py†L91-L118】
- **Exigência de segredos**: `backend/app/config.py` depende de variáveis obrigatórias (`JWT_SECRET_KEY`, `SPA_AUTH_USERNAME`, `KMS_MASTER_KEY`) sem fallback, tornando o deploy frágil e propenso a execuções locais inseguras com valores padrão improvisados.【F:backend/app/config.py†L10-L57】
- **Ausência de rate limiting**: nem FastAPI nem o proxy Express implementam limites de requisição ou throttling, abrindo espaço para abuso de endpoints críticos (LLM/OCR).【F:backend/app/main.py†L159-L235】【F:server/index.ts†L124-L200】

## 4. Frontend, UI/UX e Performance
- **Dependência de CDN externo**: React, Tailwind, XLSX e demais libs são importadas via `https://aistudiocdn.com`, dificultando SRI, uso offline e compliance corporativa.【F:index.html†L7-L33】
- **Sessão SPA vulnerável**: tokens de acesso são persistidos em `localStorage`, sem segmentação por escopo, invalidação server-side ou mitigação contra XSS.【F:services/authService.ts†L1-L66】
- **Fluxo principal sem fallback**: `App.tsx` controla pipeline com estados locais mas não oferece degradação quando `runPipeline` falha ou quando `auditReport` não é carregado; operações como export SPED manipulam DOM diretamente, sem feedback acessível.【F:App.tsx†L21-L149】
- **Acessibilidade limitada**: o dropzone de upload é uma `<div>` não focável e sem `role`, impossibilitando interação via teclado assistivo; ausência de mensagens `aria-live` para erros de upload.【F:components/FileUpload.tsx†L392-L456】
- **Telemetry agressiva**: `services/telemetry.ts` inicializa provedores OTLP na primeira chamada sem verificar disponibilidade de endpoint, com `exportIntervalMillis` fixo em 10s, o que pode travar o boot em ambientes desconectados.【F:services/telemetry.ts†L46-L200】

## 5. Testes, Qualidade e Métricas
- **Lint quebrado**: `npm run lint` aborta com 93 erros devido a `parserOptions.tsconfigRootDir` configurado como objeto, além de uso de APIs globais (`URL`) sem declaração.【6731fa†L1-L88】
- **TypeScript falha**: `npx tsc --noEmit` acusa 96 erros por marcadores de conflito e declarações inválidas nos agentes, impedindo build e qualquer análise estática séria.【4e7cf5†L1-L128】
- **Cobertura inalcançável**: apesar de `jest.config.ts` definir thresholds de 90%, a suíte não pode rodar enquanto o TypeScript não compila; pipelines `report:quality` e `load` ficam bloqueados pelo build inconsistente.【F:jest.config.ts†L1-L40】【4e7cf5†L1-L128】
- **Métricas ausentes**: não há geração automática de complexidade ciclomática, acoplamento ou consumo de memória; scripts de auditoria dependem de builds concluídos, inexistentes no estado atual.【683578†L1-L33】【6731fa†L1-L88】

## 6. Design, Responsividade e Acessibilidade
- **Hierarquia visual**: componentes chave (ReportViewer, Dashboard, ChatPanel) competem por espaço fixo (`grid-cols-1 lg:grid-cols-2`) sem considerar leitores móveis; não há lógica para suspender animações em pipelines longos.【F:App.tsx†L151-L198】
- **Foco e instruções**: erros e toasts dependem de texto simples sem `role="alert"`; `FileUpload` não fornece descrições acessíveis nem manipula foco após falha.【F:components/FileUpload.tsx†L392-L456】
- **Compatibilidade cross-platform**: uso de `URL.createObjectURL` para exportação SPED sem fallback para navegadores restritos ou workers, aumentando risco de falhas silenciosas.【F:App.tsx†L104-L149】

## 7. Vulnerabilidades e Gargalos Prioritários
1. **Resolver conflitos de merge e definir arquitetura alvo (backend-first ou proxy Node)** – unificar `main.py`, `useAgentOrchestrator`, agentes e serviços antes de qualquer evolução.【F:backend/app/main.py†L1-L273】【F:hooks/useAgentOrchestrator.ts†L1-L200】
2. **Endurecer autenticação e CORS** – restringir origens confiáveis, mover tokens para cookies `HttpOnly` e remover bootstrap automático de credenciais padrão.【F:backend/app/main.py†L91-L236】【F:services/authService.ts†L1-L66】
3. **Restaurar esteira de qualidade** – corrigir configuração ESLint (`tsconfigRootDir`), remover marcadores de conflito e garantir que `tsc`, `jest --coverage` e `cypress run` possam executar em CI.【6731fa†L1-L88】【4e7cf5†L1-L128】
4. **Consolidar telemetria e observabilidade** – decidir entre OTLP via frontend ou backend e adicionar detecção de disponibilidade para evitar bloqueios na inicialização.【F:services/telemetry.ts†L46-L200】
5. **Localizar dependências críticas** – incorporar React/Tailwind e libs de exportação no bundle local para cumprir políticas de segurança e permitir empacotamento offline.【F:index.html†L7-L33】
6. **Endereçar acessibilidade** – tornar dropzones focáveis (`role="button"`, `tabIndex=0`), adicionar `aria-live` em mensagens de erro e revisar contraste/padrões WCAG.【F:components/FileUpload.tsx†L392-L456】

## 8. Recomendações para CI/CD e Métricas
- **Pipeline mínima**: sequenciar `npm run lint` → `npx tsc --noEmit` → `npm test -- --coverage` → `npm run e2e` após build unificado; falhas devem bloquear merge.【6731fa†L1-L88】【4e7cf5†L1-L128】
- **Relatórios automatizados**: após estabilizar builds, rodar `npm run report:quality` e publicar artefatos (cobertura Jest, logs OTLP, `audit_log.jsonl`) em storage seguro e dashboards observáveis.【683578†L1-L33】【F:backend/app/main.py†L91-L236】
- **Métricas adicionais**: integrar ferramentas de complexidade (ex. `radon`, `ts-complex`) e acoplamento no pipeline; registrar tempo médio de resposta a partir de spans OTLP e persistir snapshots no repositório de relatórios.【F:services/telemetry.ts†L46-L200】
- **Governança de segredos**: sincronizar vault backend com proxy Node via rota autenticada ou eliminar duplicidade; incorporar validação de rotação de chaves antes do deploy.【F:backend/app/main.py†L91-L169】【F:server/index.ts†L124-L200】

## 9. Próximos Passos Prioritários
1. **Sprint 0 (Correção estrutural)**: resolver conflitos, remover código morto e escolher arquitetura única (preferencialmente backend FastAPI + SPA fina). Validar build completo localmente.
2. **Sprint 1 (Segurança & Sessão)**: implementar cookies `HttpOnly`, revisar CORS, adicionar rate limiting no FastAPI e TLS entre proxy/cliente. Ajustar onboarding para impedir credenciais padrão.
3. **Sprint 2 (UX & A11y)**: revisar componentes com foco em navegação por teclado, mensagens de erro e responsividade; migrar dependências CDN para bundler.
4. **Sprint 3 (Observabilidade & Métricas)**: estabilizar telemetria, publicar dashboards e scripts de análise de complexidade. Integrar resultados ao pipeline CI/CD com armazenamento de artefatos.

---
Relatório preparado por: **Auditoria Automatizada gpt-5-codex**
