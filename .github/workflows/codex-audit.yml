name: Codex Audit & Autofix
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  codex-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install audit dependencies
        run: |
          pip install ruff mypy bandit radon pip-audit
          npm install -g @lhci/cli gitleaks pa11y-ci axe-core

      - name: Ensure codex_reports directory exists
        run: |
          mkdir -p codex_reports
          echo "Created codex_reports directory ‚úÖ"

      - name: Run Codex Audit Suite
        run: |
          echo "Starting Codex Audit Suite..."
          if [ -f scripts_run_codex_suite.py ]; then
            python scripts_run_codex_suite.py || echo "‚ö†Ô∏è Script executed with warnings"
          else
            echo "‚ö†Ô∏è scripts_run_codex_suite.py not found ‚Äî skipping"
          fi
          echo "Codex Audit Suite completed ‚úÖ"

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codex_reports
          path: codex_reports/
          if-no-files-found: warn
          retention-days: 7

      - name: Commit and push auto-fixes
        run: |
          git config --global user.name "codex-bot"
          git config --global user.email "actions@github.com"
          git checkout -b codex/audit-autofix || git checkout codex/audit-autofix
          git add .
          git commit -am "[codex-audit] Automated fixes and reports" || echo "No changes to commit"
          git push origin codex/audit-autofix --force

      - name: Create Pull Request if needed
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: codex/audit-autofix
          base: main
          title: "[Codex] Automated Audit & Autofix"
          body: |
            Codex Audit Suite executed successfully.

            ‚úÖ Reports generated and uploaded as artifacts.
            ‚úÖ Automatic fixes applied where possible.
            üîç Review the changes before merging.
          commit-message: "[codex-audit] apply automated fixes"
          labels: codex, audit, autofix
